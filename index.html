<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Müzik Çalar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d2d3f; /* Sidebar track */
        }
        ::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #777;
        }
        /* Ensure body takes full height and uses Inter font */
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll */
        }
        /* Hide default audio player controls */
        audio {
           width: 100%;
           max-width: 500px; /* Limit player width */
           margin-top: 1rem; /* Add space above player */
           filter: invert(15%) sepia(5%) saturate(1200%) hue-rotate(190deg) brightness(95%) contrast(90%); /* Subtle color adjustment */
           border-radius: 999px; /* Rounded corners for the player */
           opacity: 0; /* Hide completely */
           pointer-events: none; /* Disable interaction with default controls */
           height: 0px; /* No height */
           visibility: hidden; /* Hide it completely */
           position: absolute; /* Remove from layout flow */
        }
        /* Custom progress bar styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            background: #e5e7eb; /* Lighter track color (gray-200) */
            border-radius: 3px;
            cursor: pointer;
            outline: none;
        }
        /* Progress fill */
        input[type="range"].seek-bar::-webkit-slider-runnable-track {
            background: linear-gradient(to right, #4f46e5 var(--progress, 0%), #e5e7eb var(--progress, 0%));
            height: 6px;
            border-radius: 3px;
        }
        input[type="range"].seek-bar::-moz-range-progress {
            background-color: #4f46e5;
            height: 6px;
             border-radius: 3px;
        }
         input[type="range"].seek-bar::-moz-range-track {
             background-color: #e5e7eb;
             height: 6px;
             border-radius: 3px;
         }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #4f46e5; /* Indigo thumb color */
            border-radius: 50%;
            cursor: pointer;
            margin-top: -5px; /* Center thumb vertically */
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #4f46e5; /* Indigo thumb color */
            border-radius: 50%;
            cursor: pointer;
            border: none; /* Remove default border in Firefox */
        }

        /* Volume bar specific thumb */
        input[type="range"].volume-bar::-webkit-slider-thumb {
            background: #6b7280; /* Gray thumb for volume */
             width: 12px;
            height: 12px;
            margin-top: -3px; /* Center thumb vertically */
        }
         input[type="range"].volume-bar::-moz-range-thumb {
            background: #6b7280; /* Gray thumb for volume */
            width: 12px;
            height: 12px;
        }


        /* Basic transition for hover effects */
        .transition-all {
            transition: all 0.2s ease-in-out;
        }
        /* Style for the custom player controls container */
        .custom-player-controls {
            background-color: rgba(255, 255, 255, 0.8); /* Slightly more opaque white */
            backdrop-filter: blur(8px); /* Stronger blur effect */
            border-radius: 16px; /* More rounded */
            padding: 15px 25px; /* Adjust padding */
            margin-top: 1.5rem; /* Space above controls */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); /* Softer shadow */
            width: 100%;
            max-width: 500px; /* Match audio player max-width */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Subtle border */
        }
        /* Styling for disabled buttons */
        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 flex">

    <aside class="w-64 md:w-72 lg:w-80 bg-gradient-to-br from-gray-900 to-slate-800 text-white p-5 flex flex-col h-screen shadow-lg">
        <h2 class="text-2xl font-bold border-b border-gray-700 pb-3 mb-4 flex items-center gap-3">
            <i class="fa fa-music text-indigo-400"></i> Müzikler
        </h2>
        <div id="musicList" class="flex-grow overflow-y-auto space-y-3 pr-2">
            </div>
    </aside>

    <main class="flex-1 bg-gradient-to-br from-gray-100 to-gray-200 flex flex-col items-center justify-center p-5 md:p-10 relative h-screen overflow-y-auto">
        <button id="adminButton" onclick="showAdminPanel()" class="absolute top-5 right-5 bg-slate-800 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all flex items-center gap-2 z-10">
            <i class="fa fa-lock"></i> Admin Girişi
        </button>

        <div id="player" class="text-center flex flex-col items-center w-full px-4">
            <img id="coverImage" src="https://placehold.co/300x300/e2e8f0/94a3b8?text=Müzik+Seçin" alt="Albüm Kapağı" width="300" height="300" class="rounded-xl shadow-xl mb-6 object-cover border-4 border-white"/>
            <audio id="audioPlayer"></audio>

            <div class="custom-player-controls">
                <div class="flex items-center gap-3 mb-3">
                    <span id="currentTime" class="text-xs font-medium text-gray-600 w-10 text-left tabular-nums">0:00</span>
                    <input type="range" id="seekBar" value="0" class="flex-grow seek-bar">
                    <span id="totalDuration" class="text-xs font-medium text-gray-600 w-10 text-right tabular-nums">0:00</span>
                </div>

                <div class="flex items-center justify-between">
                     <div class="w-1/4 flex justify-start">
                        </div>

                    <div class="flex items-center justify-center gap-4 flex-grow">
                        <button id="prevBtn" class="text-gray-600 hover:text-gray-900 transition-colors w-8 h-8" aria-label="Önceki Şarkı" onclick="playPrevious()" disabled>
                             <i class="fa fa-backward-step fa-lg"></i>
                        </button>
                        <button id="playPauseBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full w-12 h-12 flex items-center justify-center text-xl shadow-md transition-all transform hover:scale-105">
                            <i class="fa fa-play fa-lg"></i>
                        </button>
                        <button id="nextBtn" class="text-gray-600 hover:text-gray-900 transition-colors w-8 h-8" aria-label="Sonraki Şarkı" onclick="playNext()" disabled>
                             <i class="fa fa-forward-step fa-lg"></i>
                        </button>
                    </div>

                    <div class="flex items-center justify-end gap-2 w-1/4">
                        <i id="volumeIcon" class="fa fa-volume-high text-gray-600 hover:text-gray-900 cursor-pointer w-5 text-center" onclick="toggleMute()"></i>
                        <input type="range" id="volumeBar" min="0" max="1" step="0.01" value="1" class="w-20 h-1.5 bg-gray-300 rounded-full appearance-none cursor-pointer volume-bar accent-indigo-500">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="adminPanel" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm text-white flex items-center justify-center z-50 hidden p-5">
        <div class="bg-slate-800 p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-md relative">
            <button onclick="closeAdminPanel()" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl transition-colors">
                <i class="fa fa-times"></i>
            </button>

            <h2 class="text-2xl font-semibold mb-6 text-center flex items-center justify-center gap-3"><i class="fa fa-user-shield text-indigo-400"></i> Admin Paneli</h2>

            <div id="loginForm" class="flex flex-col items-center">
                 <input type="password" id="adminPass" placeholder="Şifre" class="w-full p-3 mb-4 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white placeholder-gray-400">
                 <button id="loginBtn" onclick="checkPassword()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                     <i class="fa fa-sign-in-alt"></i> Giriş Yap
                 </button>
            </div>

            <div id="adminControls" class="hidden flex-col space-y-4 mt-6">
                <input type="text" id="musicName" placeholder="Müzik Adı" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white placeholder-gray-400">

                <label class="block text-sm font-medium text-gray-300">Müzik Dosyası (MP3, WAV...):</label>
                <input type="file" id="musicFile" accept="audio/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200 cursor-pointer">

                <label class="block text-sm font-medium text-gray-300">Kapak Resmi (İsteğe Bağlı):</label>
                <input type="file" id="musicImage" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200 cursor-pointer">

                <button onclick="addMusic()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                    <i class="fa fa-plus"></i> Müziği Ekle
                </button>

                <hr class="border-gray-600 my-4">

                <label for="deleteSelect" class="block text-sm font-medium text-gray-300">Silinecek Müziği Seç:</label>
                <select id="deleteSelect" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-white">
                    </select>
                <button onclick="deleteMusic()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                    <i class="fa fa-trash"></i> Seçilen Müziği Sil
                </button>
            </div>
        </div>
    </div>

    <script>
        let db;
        // DOM Elements
        const musicList = document.getElementById('musicList');
        const audioPlayer = document.getElementById('audioPlayer');
        const coverImage = document.getElementById('coverImage');
        const deleteSelect = document.getElementById('deleteSelect');
        const adminButton = document.getElementById('adminButton');
        const adminPanelDiv = document.getElementById('adminPanel');
        const adminControlsDiv = document.getElementById('adminControls');
        const adminPassInput = document.getElementById('adminPass');
        const loginButton = document.getElementById('loginBtn');
        const loginForm = document.getElementById('loginForm');

        // Custom Player Elements
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playPauseIcon = playPauseBtn.querySelector('i');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const seekBar = document.getElementById('seekBar');
        const currentTimeSpan = document.getElementById('currentTime');
        const totalDurationSpan = document.getElementById('totalDuration');
        const volumeBar = document.getElementById('volumeBar');
        const volumeIcon = document.getElementById('volumeIcon');

        // State Variables
        const defaultCover = 'https://placehold.co/300x300/e2e8f0/94a3b8?text=Müzik+Seçin';
        let currentMusicId = null; // ID of the currently loaded music
        let currentMusicIndex = -1; // Index in the currently rendered list
        let musicData = []; // Array to hold the current list of music objects
        let lastVolume = 1; // Store volume before mute

        // --- IndexedDB Setup ---
        const dbRequest = indexedDB.open('musicDatabase', 1);

        dbRequest.onsuccess = function(event) {
            db = event.target.result;
            console.log("Veritabanı başarıyla açıldı.");
            renderMusics(); // Initial render
        };

        dbRequest.onerror = function(event) {
            console.error('Veritabanı açılırken hata oluştu: ', event.target.error);
            alert('Veritabanı hatası. Lütfen konsolu kontrol edin.');
        };

        dbRequest.onupgradeneeded = function(event) {
            console.log("Veritabanı yükseltiliyor...");
            const db = event.target.result;
            if (!db.objectStoreNames.contains('musics')) {
                const objectStore = db.createObjectStore('musics', { keyPath: 'id', autoIncrement: true });
                objectStore.createIndex('name', 'name', { unique: false });
                console.log("Müzikler object store oluşturuldu.");
            }
        };

        // --- Format Time (Helper Function) ---
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "0:00"; // Handle invalid input
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // --- Player Event Listeners ---
        playPauseBtn.addEventListener('click', togglePlayPause);
        audioPlayer.addEventListener('timeupdate', updateSeekBar);
        audioPlayer.addEventListener('loadedmetadata', setDuration);
        audioPlayer.addEventListener('play', () => playPauseIcon.className = 'fa fa-pause fa-lg');
        audioPlayer.addEventListener('pause', () => playPauseIcon.className = 'fa fa-play fa-lg');
        audioPlayer.addEventListener('ended', playNext); // Play next song when current ends
        seekBar.addEventListener('input', seek);
        volumeBar.addEventListener('input', changeVolume);

        // --- Player Control Functions ---
        function togglePlayPause() {
            if (!audioPlayer.src || currentMusicId === null) return; // Do nothing if no song is loaded
            if (audioPlayer.paused) {
                audioPlayer.play().catch(e => console.error("Oynatma hatası:", e));
            } else {
                audioPlayer.pause();
            }
        }

        function updateSeekBar() {
            if (audioPlayer.duration && isFinite(audioPlayer.duration)) {
                const percentage = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                seekBar.value = percentage;
                // Update CSS variable for progress fill
                seekBar.style.setProperty('--progress', `${percentage}%`);
                currentTimeSpan.textContent = formatTime(audioPlayer.currentTime);
            } else {
                 seekBar.value = 0;
                 seekBar.style.setProperty('--progress', `0%`);
                 currentTimeSpan.textContent = formatTime(0);
            }
        }

        function setDuration() {
             if (audioPlayer.duration && isFinite(audioPlayer.duration)) {
                totalDurationSpan.textContent = formatTime(audioPlayer.duration);
                seekBar.value = 0; // Reset seek bar on new song load
                seekBar.style.setProperty('--progress', `0%`);
                currentTimeSpan.textContent = formatTime(0);
            } else {
                totalDurationSpan.textContent = "0:00";
                currentTimeSpan.textContent = "0:00";
                seekBar.value = 0;
                seekBar.style.setProperty('--progress', `0%`);
            }
        }

        function seek() {
            if (!audioPlayer.src || !audioPlayer.duration || !isFinite(audioPlayer.duration)) return;
            const time = (seekBar.value / 100) * audioPlayer.duration;
            audioPlayer.currentTime = time;
            // Update progress immediately while dragging
            seekBar.style.setProperty('--progress', `${seekBar.value}%`);
        }

        function changeVolume() {
            audioPlayer.volume = volumeBar.value;
            updateVolumeIcon(audioPlayer.volume);
             // Store volume if not muted
            if (audioPlayer.volume > 0) {
                lastVolume = audioPlayer.volume;
            }
        }

        function updateVolumeIcon(volume) {
             if (volume === 0) {
                volumeIcon.className = 'fa fa-volume-xmark text-gray-600 hover:text-gray-900 cursor-pointer w-5 text-center';
            } else if (volume < 0.5) {
                volumeIcon.className = 'fa fa-volume-low text-gray-600 hover:text-gray-900 cursor-pointer w-5 text-center';
            } else {
                volumeIcon.className = 'fa fa-volume-high text-gray-600 hover:text-gray-900 cursor-pointer w-5 text-center';
            }
        }

        function toggleMute() {
            if (audioPlayer.volume > 0) {
                // Mute: store current volume, set volume to 0
                lastVolume = audioPlayer.volume; // Store before muting
                audioPlayer.volume = 0;
                volumeBar.value = 0;
                updateVolumeIcon(0);
            } else {
                // Unmute: restore last volume
                audioPlayer.volume = lastVolume;
                volumeBar.value = lastVolume;
                updateVolumeIcon(lastVolume);
            }
        }

        function loadAndPlayMusic(index) {
            if (index < 0 || index >= musicData.length) {
                console.log("Geçersiz müzik indexi:", index);
                 // Stop player if index is out of bounds
                 audioPlayer.pause();
                 audioPlayer.src = '';
                 coverImage.src = defaultCover;
                 currentMusicId = null;
                 currentMusicIndex = -1;
                 updatePlayerUIState(); // Reset UI
                return;
            }

            const music = musicData[index];
            console.log(`Yükleniyor: ${music.name} (ID: ${music.id}, Index: ${index})`);

            audioPlayer.src = music.audioUrl;
            coverImage.src = music.imageUrl || defaultCover;
            currentMusicId = music.id;
            currentMusicIndex = index;

            // Update active state styling in the list
            document.querySelectorAll('.music-item').forEach((item, idx) => {
                item.classList.toggle('bg-indigo-600', idx === index);
                item.classList.toggle('bg-gray-800', idx !== index); // Ensure others are default
                 // Scroll into view if needed
                 if (idx === index) {
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                 }
            });

            // Reset and play
            audioPlayer.load(); // Important to load the new source
            audioPlayer.play().catch(e => {
                console.error("Otomatik oynatma engellendi veya hata:", e);
                playPauseIcon.className = 'fa fa-play fa-lg'; // Show play icon if autoplay fails
            });
            updatePlayerUIState(); // Update buttons etc.
        }

        function playNext() {
            if (musicData.length === 0) return;
            let nextIndex = (currentMusicIndex + 1) % musicData.length; // Wrap around
            loadAndPlayMusic(nextIndex);
        }

        function playPrevious() {
             if (musicData.length === 0) return;
             // If current time is > 3 seconds, restart current song, otherwise go to previous
             if (audioPlayer.currentTime > 3 && currentMusicIndex !== -1) {
                 audioPlayer.currentTime = 0;
                 audioPlayer.play().catch(e => console.error("Oynatma hatası:", e));
             } else {
                let prevIndex = (currentMusicIndex - 1 + musicData.length) % musicData.length; // Wrap around correctly
                loadAndPlayMusic(prevIndex);
             }
        }

         function updatePlayerUIState() {
            // Enable/disable prev/next buttons based on list size
            const hasMultipleSongs = musicData.length > 1;
            prevBtn.disabled = !hasMultipleSongs;
            nextBtn.disabled = !hasMultipleSongs;

            // Update play/pause icon based on current state
            if (audioPlayer.paused) {
                playPauseIcon.className = 'fa fa-play fa-lg';
            } else {
                playPauseIcon.className = 'fa fa-pause fa-lg';
            }

             // Reset times if no song is loaded
            if (currentMusicId === null) {
                currentTimeSpan.textContent = "0:00";
                totalDurationSpan.textContent = "0:00";
                seekBar.value = 0;
                seekBar.style.setProperty('--progress', `0%`);
            }
        }


        // --- Render Music List ---
        function renderMusics() {
            if (!db) {
                console.error("Veritabanı henüz hazır değil.");
                return;
            }
            // Clear previous lists
            musicList.innerHTML = '';
            deleteSelect.innerHTML = '<option value="" disabled selected>Silmek için seçin...</option>';
            musicData = []; // Clear internal data array

            try {
                const transaction = db.transaction(['musics'], 'readonly');
                const objectStore = transaction.objectStore('musics');
                const request = objectStore.getAll();

                request.onsuccess = function(event) {
                    musicData = event.target.result; // Store fetched data
                    console.log(`Bulunan müzik sayısı: ${musicData.length}`);

                    if (musicData.length === 0) {
                        musicList.innerHTML = '<p class="text-gray-400 text-center mt-4">Henüz müzik eklenmemiş.</p>';
                         // Reset player if list becomes empty
                         if (currentMusicId !== null) {
                            audioPlayer.pause();
                            audioPlayer.src = '';
                            coverImage.src = defaultCover;
                            currentMusicId = null;
                            currentMusicIndex = -1;
                         }
                         updatePlayerUIState(); // Update button states
                        return; // Exit if no music
                    }

                    // Find the index of the currently playing song in the new list
                    currentMusicIndex = musicData.findIndex(music => music.id === currentMusicId);

                    musicData.forEach((music, index) => {
                        // Create sidebar item
                        const div = document.createElement('div');
                        // Apply active class if this is the currently loaded song
                        div.className = `music-item flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all transform hover:scale-[1.03] ${music.id === currentMusicId ? 'bg-indigo-600' : 'bg-gray-800 hover:bg-indigo-700'}`;
                        div.dataset.id = music.id; // Store music ID

                        const img = document.createElement('img');
                        img.src = music.imageUrl || 'https://placehold.co/60x60/7f9cf5/ffffff?text=♪'; // Default icon if no image
                        img.alt = "Kapak";
                        img.className = "w-12 h-12 rounded-md object-cover flex-shrink-0";
                        img.onerror = () => img.src = 'https://placehold.co/60x60/7f9cf5/ffffff?text=♪'; // Fallback image
                        div.appendChild(img);

                        const title = document.createElement('span');
                        title.className = "font-medium truncate flex-grow";
                        title.innerText = music.name;
                        div.appendChild(title);

                        div.onclick = () => {
                             loadAndPlayMusic(index); // Load and play based on index
                        };
                        musicList.appendChild(div);

                        // Create delete select option
                        const option = document.createElement('option');
                        option.value = music.id;
                        option.text = music.name;
                        deleteSelect.appendChild(option);
                    });

                     updatePlayerUIState(); // Update buttons after rendering
                };

                request.onerror = function(event) {
                    console.error('Müzikler alınırken hata: ', event.target.error);
                    musicList.innerHTML = '<p class="text-red-400 text-center mt-4">Müzikler yüklenemedi.</p>';
                     updatePlayerUIState(); // Update buttons even on error
                }

            } catch (error) {
                console.error("RenderMusics içinde hata:", error);
                alert("Müzikleri listelerken bir sorun oluştu.");
                 updatePlayerUIState(); // Update buttons on catch
            }
        }

        // --- Add Music ---
        function addMusic() {
            const nameInput = document.getElementById('musicName');
            const fileInput = document.getElementById('musicFile');
            const imageInput = document.getElementById('musicImage');

            const name = nameInput.value.trim();
            const file = fileInput.files[0];
            const image = imageInput.files[0];

            if (!file || !name) {
                alert('Müzik adı ve müzik dosyası alanları zorunludur!');
                return;
            }

            // Show loading indicator (optional)
            const addButton = adminControlsDiv.querySelector('button[onclick="addMusic()"]');
            const originalButtonText = addButton.innerHTML;
            addButton.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Ekleniyor...';
            addButton.disabled = true;

            const audioReader = new FileReader();
            audioReader.onload = function(e) {
                const musicObj = {
                    name: name,
                    audioUrl: e.target.result,
                    imageUrl: null
                };

                if (image) {
                    if (image.size > 5 * 1024 * 1024) { // 5MB limit
                       alert("Resim dosyası çok büyük! (Maksimum 5MB)");
                       // Restore button
                       addButton.innerHTML = originalButtonText;
                       addButton.disabled = false;
                       return;
                    }
                    const imageReader = new FileReader();
                    imageReader.onload = function(event) {
                        musicObj.imageUrl = event.target.result;
                        saveMusic(musicObj, addButton, originalButtonText); // Pass button state
                    };
                    imageReader.onerror = function() {
                        console.error("Resim dosyası okunurken hata.");
                        alert("Resim dosyası okunurken bir hata oluştu.");
                         // Restore button
                        addButton.innerHTML = originalButtonText;
                        addButton.disabled = false;
                    }
                    imageReader.readAsDataURL(image);
                } else {
                    saveMusic(musicObj, addButton, originalButtonText); // Pass button state
                }
            };
            audioReader.onerror = function() {
                console.error("Ses dosyası okunurken hata.");
                alert("Ses dosyası okunurken bir hata oluştu.");
                 // Restore button
                addButton.innerHTML = originalButtonText;
                addButton.disabled = false;
            }
            audioReader.readAsDataURL(file);
        }

        // --- Save Music to DB ---
        function saveMusic(musicObj, buttonElement, originalButtonHTML) { // Receive button state
            if (!db) {
                alert("Veritabanı bağlantısı yok.");
                 // Restore button
                buttonElement.innerHTML = originalButtonHTML;
                buttonElement.disabled = false;
                return;
            }
            try {
                const transaction = db.transaction(['musics'], 'readwrite');
                const objectStore = transaction.objectStore('musics');
                const request = objectStore.add(musicObj);

                request.onsuccess = function() {
                    console.log("Müzik başarıyla eklendi:", musicObj.name);
                    renderMusics(); // Refresh lists
                    // Clear form fields
                    document.getElementById('musicName').value = '';
                    document.getElementById('musicFile').value = '';
                    document.getElementById('musicImage').value = '';
                    alert('Müzik başarıyla eklendi!');
                    // limitMusicCount(50); // Optional: Limit total music count
                     // Restore button
                    buttonElement.innerHTML = originalButtonHTML;
                    buttonElement.disabled = false;
                };

                request.onerror = function(event) {
                    console.error('Müzik eklenirken hata oluştu: ', event.target.error);
                    alert(`Müzik eklenemedi: ${event.target.error.message}`);
                     // Restore button
                    buttonElement.innerHTML = originalButtonHTML;
                    buttonElement.disabled = false;
                };
            } catch (error) {
                 console.error("SaveMusic içinde hata:", error);
                 alert("Müzik kaydedilirken bir sorun oluştu.");
                  // Restore button
                 buttonElement.innerHTML = originalButtonHTML;
                 buttonElement.disabled = false;
            }
        }

        // --- OPTIONAL: Limit Music Count ---
        // function limitMusicCount(maxCount) { ... } // Keep the function if needed

        // --- Delete Music ---
        function deleteMusic() {
            const musicIdToDelete = parseInt(deleteSelect.value);
            if (isNaN(musicIdToDelete)) {
                alert('Lütfen silinecek bir müzik seçin.');
                return;
            }

            const musicNameToDelete = deleteSelect.options[deleteSelect.selectedIndex].text;
            if (!confirm(`"${musicNameToDelete}" adlı müziği silmek istediğinizden emin misiniz?`)) {
                return; // User cancelled
            }

            if (!db) {
                 alert("Veritabanı bağlantısı yok.");
                 return;
            }

            try {
                const transaction = db.transaction(['musics'], 'readwrite');
                const objectStore = transaction.objectStore('musics');
                const request = objectStore.delete(musicIdToDelete);

                request.onsuccess = function() {
                    console.log(`Müzik ID ${musicIdToDelete} silindi.`);

                    // Check if the deleted music was the current one
                    const wasCurrentMusicDeleted = (currentMusicId === musicIdToDelete);

                    // Stop player and clear info if current song was deleted
                    if (wasCurrentMusicDeleted) {
                        audioPlayer.pause();
                        audioPlayer.src = '';
                        coverImage.src = defaultCover;
                        currentMusicId = null;
                        currentMusicIndex = -1; // Reset index
                    }

                    // Re-render the music list *after* handling the player state
                    renderMusics();

                    alert(`"${musicNameToDelete}" başarıyla silindi!`);

                     // If the deleted song was playing, try to play the next available song
                     if (wasCurrentMusicDeleted && musicData.length > 0) {
                         // The renderMusics function will have updated musicData
                         // We need to determine the correct next index based on the *old* index
                         // Since renderMusics was called, currentMusicIndex is now -1
                         // Let's try loading the song at index 0 if available
                         loadAndPlayMusic(0);
                     } else if (musicData.length === 0) {
                         // If list is now empty, ensure player UI is fully reset
                         updatePlayerUIState();
                     }

                };

                request.onerror = function(event) {
                    console.error('Müzik silinirken hata oluştu: ', event.target.error);
                    alert(`Müzik silinemedi: ${event.target.error.message}`);
                };
            } catch(error) {
                 console.error("DeleteMusic içinde hata:", error);
                 alert("Müzik silinirken bir sorun oluştu.");
            }
        }

        // --- Admin Panel Visibility ---
        function showAdminPanel() {
            adminPanelDiv.classList.remove('hidden');
            adminPanelDiv.classList.add('flex');
            adminPassInput.focus();
        }

        function closeAdminPanel() {
            adminPanelDiv.classList.add('hidden');
            adminPanelDiv.classList.remove('flex');
            // Hide controls and show login form again
            adminControlsDiv.classList.add('hidden');
            loginForm.classList.remove('hidden'); // Show login form
            loginForm.classList.add('flex'); // Make login form flex
            adminPassInput.value = ''; // Clear password field
        }

        // --- Admin Password Check ---
        function checkPassword() {
            const pass = adminPassInput.value;
            // !!! GÜVENLİK UYARISI: Şifre KESİNLİKLE sunucu tarafında kontrol edilmelidir. !!!
            // Bu sadece görsel bir örnektir.
            if (pass === '1234') { // Örnek şifre
                loginForm.classList.add('hidden'); // Hide login form
                loginForm.classList.remove('flex');
                adminControlsDiv.classList.remove('hidden');
                adminControlsDiv.classList.add('flex', 'flex-col', 'space-y-4');
            } else {
                alert('Şifre yanlış!');
                adminPassInput.value = ''; // Clear password field on failure
                adminPassInput.focus();
            }
        }

        // --- Initial Setup ---
        coverImage.src = defaultCover;
        adminControlsDiv.classList.add('hidden');
        // Set initial volume bar value based on player's default volume
        volumeBar.value = audioPlayer.volume;
        updateVolumeIcon(audioPlayer.volume); // Update icon initially
        updatePlayerUIState(); // Set initial button states

    </script>

</body>
</html>
